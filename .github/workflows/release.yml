name: Build PhotoRenamer

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 1.5.2)'
        required: true
        default: '1.0.0'

jobs:
  build:
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - os: macos-14
            name: macOS
            type: dmg
            icon: src/main/resources/icons/icon.icns
            extra: "--mac-package-identifier com.samfort.photorenamer"
          - os: windows-latest
            name: Windows
            type: msi
            icon: src/main/resources/icons/icon.ico
            extra: "--win-menu --win-shortcut --win-dir-chooser"

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build JAR
        run: mvn -B -DskipTests clean package

      # ← ВСЁ В BASH, даже на Windows
      - name: Prepare input directory + icon
        shell: bash
        run: |
          mkdir -p build-input
          cp target/photo-renamer-*.jar build-input/
          mv build-input/photo-renamer-*.jar "build-input/photo-renamer-${{ inputs.version }}.jar"

          # Копируем иконку с ПРАВИЛЬНЫМ именем в build-input (относительно input)
          ICON_SRC="${{ matrix.config.icon }}"
          ICON_NAME=$(basename "$ICON_SRC")
          if [ -f "$ICON_SRC" ]; then
            cp "$ICON_SRC" "build-input/$ICON_NAME"
            echo "Icon copied: $ICON_SRC → build-input/$ICON_NAME"
          else
            echo "Warning: Icon not found at $ICON_SRC"
          fi

      - name: Create minimal JRE (jlink)
        shell: bash
        run: |
          "$JAVA_HOME/bin/jlink" \
            --module-path "$JAVA_HOME/jmods" \
            --add-modules java.base,java.desktop,java.logging,java.naming,java.sql,java.management,java.instrument,javafx.controls,javafx.fxml  # если JavaFX, иначе удали javafx.* \
            --strip-debug --no-header-files --no-man-pages \
            --compress=2 \
            --output custom-jre

      - name: Build installer with icon (100% working)
        shell: bash
        run: |
          # Определяем правильное имя иконки для текущей ОС
          ICON_NAME=$(basename "${{ matrix.config.icon }}")
          ICON_ARG=""
          if [ -f "build-input/$ICON_NAME" ]; then
            ICON_ARG="--icon $ICON_NAME"
            echo "Using icon: $ICON_NAME"
          else
            echo "No icon in build-input/$ICON_NAME — using default"
          fi

          "$JAVA_HOME/bin/jpackage" \
            --input build-input \
            --name PhotoRenamer \
            --main-jar "photo-renamer-${{ inputs.version }}.jar" \
            --main-class com.grok.PhotoRenamerWithGUI \
            --runtime-image custom-jre \
            --app-version "${{ inputs.version }}" \
            --type ${{ matrix.config.type }} \
            --dest output \
            ${{ matrix.config.extra }} \
            $ICON_ARG \
            --verbose

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: PhotoRenamer-${{ matrix.config.name }}-v${{ inputs.version }}
          path: output/*
