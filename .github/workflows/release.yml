name: Build PhotoRenamer

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 1.5.2)'
        required: true
        default: '1.0.0'

jobs:
  build:
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - os: macos-14
            name: macOS
            type: dmg
            extra: "--mac-package-identifier com.samfort.photorenamer"
          - os: windows-latest
            name: Windows
            type: msi
            extra: "--win-menu --win-shortcut --win-dir-chooser"

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build JAR
        run: mvn -B -DskipTests clean package

      # Шаг 1: Подготовка директорий и копирование JAR
      - name: Prepare input directory
        shell: bash
        run: |
          mkdir -p build-input
          cp target/photo-renamer-*.jar build-input/
          mv build-input/photo-renamer-*.jar "build-input/photo-renamer-${{ inputs.version }}.jar"

      # Шаг 2: Подготовка ресурсов и иконки в правильной структуре
      - name: Prepare jpackage resources and icon structure
        shell: bash
        run: |
          ICON_SRC_MAC="src/main/resources/icons/icon.icns"
          ICON_SRC_WIN="src/main/resources/icons/icon.ico"
          
          # Для macOS: иконка должна быть в Contents/Resources/
          if [[ "${{ matrix.config.os }}" == "macos-14" ]]; then
            mkdir -p Contents/Resources
            if [ -f "$ICON_SRC_MAC" ]; then
              cp "$ICON_SRC_MAC" "Contents/Resources/icon.icns"
              chmod 755 "Contents/Resources/icon.icns"
              echo "Mac icon prepared at Contents/Resources/icon.icns"
            else
              echo "ERROR: Mac icon file not found at $ICON_SRC_MAC"
            fi
          
          # Для Windows: иконка должна быть в корне ресурсной директории
          elif [[ "${{ matrix.config.os }}" == "windows-latest" ]]; then
            if [ -f "$ICON_SRC_WIN" ]; then
              cp "$ICON_SRC_WIN" "icon.ico"
              chmod 755 "icon.ico"
              echo "Windows icon prepared at icon.ico"
            else
              echo "ERROR: Windows icon file not found at $ICON_SRC_WIN"
            fi
          fi

      - name: Create minimal JRE (jlink)
        shell: bash
        run: |
          JMODS_PATH=$(find "$JAVA_HOME" -type d -name "jmods" | head -1)
          echo "jmods found at: $JMODS_PATH"

          "$JAVA_HOME/bin/jlink" \
            --module-path "$JMODS_PATH" \
            --add-modules java.base,java.desktop,java.logging,java.naming,java.sql,java.management,java.instrument \
            --strip-debug --no-header-files --no-man-pages \
            --compress=2 \
            --output custom-jre

      - name: Build installer
        shell: bash
        run: |
          # win-console только для Windows
          CONSOLE_ARG=""
          if [[ "${{ matrix.config.os }}" == "windows-latest" ]]; then
            CONSOLE_ARG="--win-console"
          fi

          COMMAND="$JAVA_HOME/bin/jpackage"
          
          COMMAND+=" --input build-input"
          COMMAND+=" --name PhotoRenamer"
          COMMAND+=" --main-jar photo-renamer-${{ inputs.version }}.jar"
          COMMAND+=" --main-class com.samfort.photorenamer.PhotoRenamer"
          COMMAND+=" --runtime-image custom-jre"
          COMMAND+=" --app-version ${{ inputs.version }}"
          COMMAND+=" --type ${{ matrix.config.type }}"
          COMMAND+=" --dest output"
          COMMAND+=" ${{ matrix.config.extra }}"

          COMMAND+=" --resource-dir ."
          COMMAND+=" $CONSOLE_ARG"

          # Выполняем команду
          $COMMAND

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: PhotoRenamer-${{ matrix.config.name }}-v${{ inputs.version }}
          path: output/*